# 機能仕様: AI リファクタリングエージェント

**フィーチャーブランチ**: `001-refactoring-agent`
**作成日**: 2025-12-14
**ステータス**: ドラフト
**入力**: ユーザー説明: "レガシーな大規模プロジェクトを、新規案件に対応しつつ効率的にリファクタリングしてコード品質を高めるために、リファクタリングすべき箇所を見つけて定期的に PR を作成する AI エージェントを作成したい。"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - ホットスポット自動検出とPR作成 (優先度: P1)

レガシーコードベースを保守する開発チームが、新機能開発を進めながら継続的にコード品質を改善したいと考えている。AI エージェントは定期的にコードベースを分析し、高優先度のリファクタリング対象（ホットスポット）を特定し、人間がレビューするためのリファクタリング提案を含むプルリクエストを自動作成する。

**優先度の理由**: これは本機能の中核的な価値提案である。新規開発と技術的負債削減のバランスを取るという主要な課題に対して、検出と提案プロセスを自動化することで直接対処する。

**独立したテスト**: 既知のホットスポットを持つサンプルレガシーリポジトリでエージェントを実行し、適切なリファクタリング提案を含む PR が作成されることを確認し、人間のレビュアーが変更を理解して承認/却下できることを検証することで完全にテスト可能。

**受け入れシナリオ**:

1. **前提条件** 変更頻度の高いファイルを含むレガシーリポジトリがある、**実行時** エージェントがスケジュール分析を実行する、**期待結果** 累積変更量が多く結合度が高いファイルをリファクタリング優先対象として特定する
2. **前提条件** ホットスポットファイルが特定されている、**実行時** エージェントがコードを分析する、**期待結果** 明確な説明を含む具体的なリファクタリング推奨事項を生成する
3. **前提条件** リファクタリング推奨事項がある、**実行時** エージェントがプルリクエストを作成する、**期待結果** PR に提案された変更、根拠、影響を受けるファイル、テスト考慮事項が含まれる
4. **前提条件** リファクタリング PR が作成されている、**実行時** 人間のレビュアーが確認する、**期待結果** 提供された明確な情報に基づいて承認、変更要求、または却下を判断できる

---

### ユーザーストーリー 2 - デッドコード検出と削除 (優先度: P2)

開発チームは、もはやアクティブに使用されていないコードを特定して削除することで、コードベースの複雑さを軽減したいと考えている。AI エージェントは、変更頻度が低く、結合度が低く、最終変更からの経過時間が長いファイルを分析してデッドコード候補を特定し、クリーンアップ PR を作成する。

**優先度の理由**: デッドコード削除は保守負担の軽減とコードベースのナビゲーション性向上という即座の価値を提供するが、アクティブな問題領域（ホットスポット）への対処よりも優先度は低い。

**独立したテスト**: 既知の未使用コード（古い機能フラグ、非推奨モジュール）を含むリポジトリでエージェントを実行し、候補を正しく特定し、実際に未使用であることを検証し、適切な検証手順を含む削除 PR を作成することを確認することでテスト可能。

**受け入れシナリオ**:

1. **前提条件** 変更頻度が低く結合度スコアが低いファイルがある、**実行時** エージェントがそれらを分析する、**期待結果** 信頼度レベルでランク付けされた潜在的なデッドコード候補を特定する
2. **前提条件** デッドコード候補がある、**実行時** エージェントがそれらを検証する、**期待結果** コードベースの他の場所や外部システムから参照されていないことを確認する
3. **前提条件** 確認されたデッドコードがある、**実行時** エージェントが削除 PR を作成する、**期待結果** PR に削除対象ファイル、影響分析、推奨検証手順が含まれる
4. **前提条件** デッドコード削除 PR がある、**実行時** レビュー時、**期待結果** ステークホルダーが承認前にビジネスロジックが本当に不要であることを確認できる

---

### ユーザーストーリー 3 - スケジュール実行とオンデマンド実行 (優先度: P1)

チームは、定期スケジュール（週次、月次）でリファクタリング分析を実行するか、必要に応じて（メジャーリリース前、機能完成後など）手動でトリガーする柔軟性を求めている。エージェントは両方の実行モードをサポートし、一貫した出力を提供する。

**優先度の理由**: 実行の柔軟性は、エージェントが異なるチームのワークフローに適合するために不可欠であり、コア機能を有用にするために必要である。

**独立したテスト**: スケジュール実行（例: 週次）を設定し、自動実行されることを確認した後、追加の手動実行をトリガーし、両方が一貫した分析結果を生成することを確認することでテスト可能。

**受け入れシナリオ**:

1. **前提条件** スケジュール（例: 毎週月曜日）が設定されている、**実行時** スケジュール時刻になる、**期待結果** エージェントが自動的に分析を実行し、リファクタリング対象が見つかれば PR を作成する
2. **前提条件** 手動トリガー要求がある、**実行時** ユーザーがエージェントを起動する、**期待結果** スケジュール実行と同じ分析を実行する
3. **前提条件** 分析結果がある、**実行時** エージェントが完了する、**期待結果** 改善を追跡するため、将来の実行と比較するために結果が保存される
4. **前提条件** 複数の連続実行がある、**実行時** エージェントが以前に特定した問題に遭遇する、**期待結果** 重複した PR の作成を回避する

---

### ユーザーストーリー 4 - 関連変更のグループ化 (優先度: P2)

ファイルごとに個別の PR を作成する代わりに、エージェントは関連ファイル（例: 頻繁に一緒に変更されるファイル、同じモジュール内のファイル）を単一の一貫した PR にグループ化し、レビューのオーバーヘッドを削減し、論理的な一貫性を維持する。

**優先度の理由**: グループ化はレビュアーの効率と変更の一貫性を向上させるが、エージェントは単一ファイルの PR でも価値を提供するため、これは機能強化である。

**独立したテスト**: 関連ファイル（例: コントローラーとそのテスト）を含むコードベースでエージェントを実行し、別々の PR ではなく両方のファイルを含む単一の PR を作成することを確認することでテスト可能。

**受け入れシナリオ**:

1. **前提条件** 高い結合度を持つ複数のファイル（頻繁に一緒に変更される）がある、**実行時** エージェントがリファクタリング対象を特定する、**期待結果** それらを単一の PR にグループ化する
2. **前提条件** 同じ論理モジュール内だが異なるディレクトリにあるファイルがある、**実行時** 同様のリファクタリングニーズを共有する、**期待結果** エージェントが適切にグループ化する
3. **前提条件** グループ化された変更がある、**実行時** PR が作成される、**期待結果** ファイル間の関係とグループ化の理由が説明される
4. **前提条件** 非常に大きなグループがある、**実行時** レビュー可能性のしきい値を超える、**期待結果** エージェントが複数の管理可能な PR に分割する

---

### エッジケース

- リポジトリに重要なホットスポットやデッドコードがない場合はどうなるか？
  - エージェントは正常に完了し、良好なコード健全性を示すサマリーレポートを出力する
- 非常に大きなファイル（10,000行以上）をシステムはどう扱うか？
  - エージェントはレビュー用にフラグを立てるが、複雑なリファクタリング推奨事項は人間の判断に委ねる可能性がある
- エージェントが PR を作成したがレビュー前に新しいコミットがプッシュされた場合はどうなるか？
  - エージェントは競合を検出し、PR を更新するか、リベースが必要であることを通知する
- 生成されたコードやベンダー依存関係をエージェントはどう扱うか？
  - エージェントは一般的なパターン（node_modules、dist、vendor、.generated）に一致するファイルを分析から除外する
- git 履歴が浅いまたは不完全な場合はどうなるか？
  - エージェントは利用可能な履歴で動作し、レポートに分析期間を記載する
- 作成された PR でマージ競合が発生した場合、システムはどう処理するか？
  - エージェントは競合を検出し、単純なケースは自動解決するか、手動介入が必要であることをマークする
- 大規模なモノレポで分析に非常に長い時間がかかる場合はどうなるか？
  - エージェントはタイムアウトメカニズムを実装し、オプションで特定のサブディレクトリを分析できる

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは git コミット履歴を分析し、設定可能な期間にわたってファイルごとの累積変更量（追加行数 + 削除行数の合計）を計算しなければならない
- **FR-002**: システムは同じコミットで頻繁に一緒に変更されるファイルを特定することで結合度スコアを計算しなければならない
- **FR-003**: システムは最近の変更頻度と過去のベースラインを比較する時系列トレンドを計算しなければならない
- **FR-004**: システムは（変更量 × 結合度スコア）に基づいてリファクタリング優先度スコアを計算しなければならない
- **FR-005**: システムは（低変更頻度 × 低結合度 × 最終変更からの時間）に基づいてデッドコード疑いスコアを計算しなければならない
- **FR-006**: システムは自動化ツールで利用するために分析結果を JSON 形式で出力しなければならない
- **FR-007**: システムはコミットの共起パターンに基づいて関連ファイルを特定してグループ化しなければならない
- **FR-008**: システムは特定されたホットスポットに対する具体的なリファクタリング推奨事項を生成しなければならない
- **FR-009**: システムは削除を推奨する前にデッドコード候補が他の場所で参照されていないことを検証しなければならない
- **FR-010**: システムは明確な説明を含む提案変更を含むプルリクエストを作成しなければならない
- **FR-011**: システムはスケジュール実行（cron ライク）と手動トリガーの両方をサポートしなければならない
- **FR-012**: システムは実行間で重複した PR を回避するために以前に作成した PR を追跡しなければならない
- **FR-013**: システムは設定可能なパターン（生成コード、依存関係）を分析から除外しなければならない
- **FR-014**: システムは履歴追跡のために分析結果をローカル JSON ファイルとして出力しなければならない（アーティファクトのアップロード/ダウンロードは外部の CI/CD ワークフローが処理する）
- **FR-015**: システムはプルリクエストの作成、更新、管理のために GitHub API と統合しなければならない
- **FR-016**: システムは根拠、影響を受けるファイル、テスト推奨事項を含む人間が読める PR 説明を提供しなければならない

### 主要エンティティ

- **リファクタリング対象**: リファクタリングが特定されたファイルまたはファイルグループ、関連する優先度スコア、結合度メトリクス、変更履歴、推奨アクションを含む
- **デッドコード候補**: 潜在的に未使用として特定されたファイルまたはコードセクション、信頼度スコア、最終変更日、参照分析結果、削除推奨事項を含む
- **分析結果**: エージェント実行の完全な出力、タイムスタンプ、分析期間、特定された対象、作成された PR、履歴追跡のためのメトリクスを含む
- **プルリクエスト**: リファクタリングされたコードまたは削除を含む提案変更、分析結果と意思決定の根拠にリンクするメタデータを含む
- **結合関係**: ファイル間で測定された共変更頻度、強度スコアを持つファイルペアとして表現される

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: チームはエージェント実行から 5 分以内に上位 10 個のリファクタリング優先ファイルを特定できる
- **SC-002**: エージェント作成の PR は人間のレビュー後に 70% 以上の承認率を達成し、質の高い推奨事項であることを示す
- **SC-003**: 開発チームはリファクタリング対象を手動で特定する時間を 80% 削減する
- **SC-004**: 特定されたホットスポットファイルのコード変更量が、エージェント推奨事項の実装後 3 ヶ月以内に 30% 減少する
- **SC-005**: デッドコード検出は手動検証に基づいて 90% 以上の精度（誤検知回避）を達成する
- **SC-006**: エージェントは最大 100,000 コミットのリポジトリで 10 分以内に分析を完了する
- **SC-007**: エージェント作成の PR の 95% に、レビュアーが追加調査なしで情報に基づいた意思決定を行うのに十分なコンテキストが含まれる
- **SC-008**: エージェントを使用するチームは、機能開発を継続しながら技術的負債の安定または減少傾向を維持できる

## 前提条件

- Git リポジトリ履歴が利用可能で正確である
- 開発チームが標準的な Git プラクティス（意味のあるコミット、ブランチワークフロー）に従っている
- GitHub が PR 作成のターゲットプラットフォームである（GitLab などの他のプラットフォームは将来の拡張の可能性がある）
- エージェントは適切なリポジトリアクセス権限を持つ CI/CD 環境で実行される
- チームはワークフロー内でエージェント作成の PR をレビューしてマージする能力を持っている
- 分析は意味解析（言語固有のパーサーが必要）ではなく構造的メトリクス（変更パターン、結合度）に焦点を当てる
- パフォーマンス目標には業界標準の慣例が適用される（典型的な大規模リポジトリで 10 分未満の分析）
- リファクタリング推奨事項は詳細なコード変換ではなく高レベルのアーキテクチャ改善に焦点を当てる

## 依存関係

- git リポジトリと完全なコミット履歴へのアクセス
- ブランチとプルリクエストを作成する権限を持つ GitHub API アクセス
- スケジュールワークフローをサポートする CI/CD プラットフォーム（例: GitHub Actions、Jenkins）
- 実行間で分析履歴を維持するためのアーティファクトストレージサービス
- リファクタリング推奨事項の生成とデッドコード検証のための AI サービス/API（例: Claude API）

## 対象外

- 人間の承認なしでの PR の自動マージ
- 言語固有の深い意味解析（型チェック、高度な静的解析）
- アクティブ開発中のリアルタイム分析（エージェントは定期的に実行され、継続的ではない）
- インタラクティブなリファクタリング IDE 統合
- マージされたリファクタリングのロールバックメカニズム（標準的な Git ワークフローで処理）
- 変更パターンと結合度を超えるカスタムコード品質メトリクス
- Git 以外のバージョン管理システムのサポート
- リファクタリングされたコードのデプロイまたはランタイム監視
