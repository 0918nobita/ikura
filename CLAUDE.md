## プロジェクト概要

レガシーな大規模コードベースを効率的にリファクタリングするために、
git ログを参照して、優先的にリファクタリングすべき変更量の多いファイルを検出する CLI ツールを開発している。

「追加された行の数」と「削除された行の数」の和を git ログ内の特定の期間で合計したものを「累計変更量」とする。
この累計変更量を各ファイルに対して算出し、その値の降順でファイルをリスト表示することで、
どのファイルを優先的にリファクタリングすればいいかが明らかになる。

---

## 拡張計画

### 目標

ikura の分析結果を AI エージェントが活用し、リファクタリング提案や Dead Code 検出を自動で PR 化するパイプラインを構築する。

### アーキテクチャ

#### ikura (CLI ツール)

純粋な分析ツール（AI 機能なし）。以下を出力する:

- 累計変更量
- 結合度
- 時系列トレンド
- リファクタリング優先度スコア
- Dead Code 疑いスコア
- JSON 形式での出力対応

#### Web コンソール

分析結果を人間が視覚的に把握するための Web UI:

- Nuxt 4 + TypeScript で静的サイト生成
- GitHub Pages の `/ikura/` サブディレクトリにホスト
- 結合度のネットワーク図・時系列トレンド・スコアを可視化
- テーブル管理には TanStack Table を採用

#### ikura-agent (別パッケージ)

ikura の JSON 出力を受け取り、AI による分析・PR 作成を行う:

- GitHub Actions ワークフロー + Claude Code Action 連携
- 任意のリポジトリに導入可能
- 定期実行 / 手動トリガー両対応
- 関連ファイルをまとめて PR 作成
- 人間がレビュー後にマージ

### 決定事項

1. **ikura の役割**: 純粋な分析 CLI ツールとして開発。AI 機能は含めない。
2. **ikura-agent の役割**: ikura を利用した AI エージェント。別パッケージとして様々なレガシーリポジトリに導入可能にする。
3. **実行トリガー**: 定期実行（週次/月次など）と手動トリガーの両方に対応。
4. **PR の粒度**: 関連ファイルをまとめて 1 つの PR を作成。
5. **レビュー方針**: 毎回人間がレビューしてからマージ。
6. **プロジェクト構成**: monorepo 構成を採用。CLI, Web コンソール、ikura-agent を同一リポジトリで開発。
7. **Web コンソールのホスティング**: GitHub Pages の `/ikura/` サブディレクトリに配置。他ツールと共存可能。
8. **キャッシュの保管方法**: GitHub Artifacts を利用する。リポジトリ本体にはキャッシュを含めない。PRマージ時に自動更新。
9. **実装の優先順位**: CLI の分析ロジックを最優先で実装し、動作確認用の簡易 Web コンソールを並行して作成。

### スコア計算の考え方

| 変更頻度 | 結合度 | 解釈 |
|---------|--------|------|
| 高 | 高 | **ホットスポット** - リファクタリング最優先候補 |
| 高 | 低 | 独立したアクティブなモジュール |
| 低 | 高 | 安定した基盤コード（または触りにくいレガシー） |
| 低 | 低 | **Dead Code 候補** - 削除検討対象 |

### ikura 拡張で追加する機能

1. **JSON 出力オプション** (`--format json`)
2. **結合度分析**: 同じコミットで一緒に変更されたファイルをベースに計算
3. **時系列トレンド**: 過去 N ヶ月 vs それ以前の変更頻度を比較
4. **リファクタリング優先度スコア**: 変更量 × 結合度 で算出
5. **Dead Code 疑いスコア**: 低変更量 × 低結合度 × 時間経過 で算出

### ikura-agent の機能

1. ikura を実行して分析結果 (JSON) を取得
2. リファクタリング優先度スコアが高いファイル群:
   - 具体的にどんな実装が含まれているかチェック
   - どんなリファクタリングが必要かを AI が判断
   - リファクタリング PR を作成
3. Dead Code 疑いスコアが高いファイル群:
   - 本当に Dead Code なのかを AI が検証
   - 確認できれば削除 PR を作成

### 未決定事項（要検討）

- [ ] ikura-agent の配布形態
- [ ] 結合度の具体的な計算アルゴリズム
- [ ] 時系列トレンドのデフォルト比較期間
- [ ] 各スコアの正規化方法（0-100 など）
- [ ] Web コンソールの命名 (ikura-console 以外の名前を検討)
- [ ] 可視化ライブラリの選定
- [ ] monorepo のディレクトリ構成
- [ ] JSON 出力スキーマの詳細
- [ ] キャッシュと差分計算の詳細な仕様

---

## 次のステップ

1. ikura に JSON 出力オプションを追加
2. 結合度分析機能を実装
3. 時系列トレンド分析機能を実装
4. リファクタリング優先度スコア / Dead Code 疑いスコアの計算ロジックを実装
5. Web コンソールのプロトタイプを作成 (Nuxt 4 + TypeScript)
6. ikura-agent の GitHub Actions ワークフローを設計・実装
